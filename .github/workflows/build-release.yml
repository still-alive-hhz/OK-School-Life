name: Build and Release Multi-Platform

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  # Windows æ„å»º (x86/x64)
  build-windows:
    name: Build Windows (${{ matrix.arch }})
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64, x86]
        include:
          - arch: x64
            python_arch: x64
            artifact_suffix: "windows-x64"
            file_ext: ".exe"
          - arch: x86
            python_arch: x86
            artifact_suffix: "windows-x86"
            file_ext: ".exe"
    steps:
      - uses: actions/checkout@v4
      
      - name: Clean workspace
        run: Remove-Item -Recurse -Force build, dist, __pycache__ -ErrorAction SilentlyContinue

      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          architecture: ${{ matrix.python_arch }}
        
      - run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pyinstaller --onefile --console ok_school_life.py
          
          $version = $env:GITHUB_REF_NAME.Substring(1)
          $newName = "ok_school_life-${{ matrix.artifact_suffix }}-$version${{ matrix.file_ext }}"
          Rename-Item -Path "dist\ok_school_life.exe" -NewName $newName
          dir dist

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_suffix }}
          path: dist/ok_school_life-${{ matrix.artifact_suffix }}-*

  # Linux æ„å»º (x86_64/ARM64)
  build-linux:
    name: Build Linux (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        arch: [x64, arm64]
        include:
          - arch: x64
            runner: ubuntu-latest
            artifact_suffix: "linux-x64"
          - arch: arm64
            runner: ubuntu-latest
            artifact_suffix: "linux-arm64"
    container: ${{ matrix.arch == 'arm64' && 'arm64v8/ubuntu:22.04' || '' }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Clean workspace
        run: rm -rf build dist __pycache__

      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pyinstaller --onefile --console ok_school_life.py
          
          version=${GITHUB_REF#refs/tags/v}
          mv dist/ok_school_life "dist/ok_school_life-${{ matrix.artifact_suffix }}-$version"
          ls -lh dist/

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_suffix }}
          path: dist/ok_school_life-${{ matrix.artifact_suffix }}-*

  # macOS æ„å»º (x64/ARM64)
  build-macos:
    name: Build macOS (${{ matrix.arch }})
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [x64, arm64]
        include:
          - arch: x64
            artifact_suffix: "macos-x64"
          - arch: arm64
            artifact_suffix: "macos-arm64"
    steps:
      - uses: actions/checkout@v4
      
      - name: Clean workspace
        run: rm -rf build dist __pycache__

      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          
          # é’ˆå¯¹ä¸åŒæ¶æ„è®¾ç½®ç¼–è¯‘å‚æ•°
          if [ "${{ matrix.arch }}" == "arm64" ]; then
            export ARCHFLAGS="-arch arm64"
          else
            export ARCHFLAGS="-arch x86_64"
          fi
          
          pyinstaller --onefile --console ok_school_life.py
          
          version=${GITHUB_REF#refs/tags/v}
          mv dist/ok_school_life "dist/ok_school_life-${{ matrix.artifact_suffix }}-$version"
          file dist/ok_school_life-${{ matrix.artifact_suffix }}-*

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_suffix }}
          path: dist/ok_school_life-${{ matrix.artifact_suffix }}-*

  # åˆ›å»ºå‘å¸ƒ
  create-release:
    name: Create Release
    needs: [build-windows, build-linux, build-macos]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/download-artifact@v4
        with:
          path: release-files
          merge-multiple: true

      - name: Verify all binaries
        run: |
          echo "=== å¯æ‰§è¡Œæ–‡ä»¶éªŒè¯ ==="
          ls -R release-files
          
          # æ£€æŸ¥æ‰€æœ‰æ¶æ„æ–‡ä»¶
          declare -a platforms=(
            "windows-x64.exe"
            "windows-x86.exe"
            "linux-x64"
            "linux-arm64"
            "macos-x64"
            "macos-arm64"
          )
          
          for platform in "${platforms[@]}"; do
            if ! ls release-files/ok_school_life-${platform}-* >/dev/null 2>&1; then
              echo "âŒ ${platform} å¯æ‰§è¡Œæ–‡ä»¶ç¼ºå¤±!"
              exit 1
            else
              echo "âœ… ${platform} æ–‡ä»¶å­˜åœ¨"
              file release-files/ok_school_life-${platform}-*
            fi
          done
          echo "âœ… æ‰€æœ‰å¹³å°æ–‡ä»¶éªŒè¯é€šè¿‡"

      - name: Generate changelog
        id: changelog
        run: |
          git fetch --tags --force
          current_tag="${{ github.ref_name }}"
          previous_tag=$(git describe --tags --abbrev=0 "$current_tag^" 2>/dev/null || echo "")
          
          if [ -z "$previous_tag" ]; then
            messages=$(git log --reverse --pretty=format:"- %s%n  â†³ æäº¤äºº: %an (%h)")
          else
            messages=$(git log --reverse --pretty=format:"- %s%n  â†³ æäº¤äºº: %an (%h)" "$previous_tag".."$current_tag")
          fi
          
          delimiter=$(openssl rand -hex 16)
          echo "changelog<<${delimiter}" >> $GITHUB_OUTPUT
          echo "$messages" >> $GITHUB_OUTPUT
          echo "${delimiter}" >> $GITHUB_OUTPUT

      - name: Generate build info
        id: build-info
        run: |
          echo "time=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT
          echo "platforms=ğŸªŸ Windows (x86/x64) | ğŸ§ Linux (x64/ARM64) | ï£¿ macOS (x64/ARM64)" >> $GITHUB_OUTPUT

      - uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: "ğŸš€ Release ${{ github.ref_name }}"
          body: |
            ## ğŸ“¦ å¤šå¹³å°æ„å»ºç»“æœ
            
            ### æ”¯æŒæ¶æ„
            ${{ steps.build-info.outputs.platforms }}
            
            ### ğŸ“ æ›´æ–°æ—¥å¿—
            ${{ steps.changelog.outputs.changelog }}
            
            ### ğŸ› ï¸ æ„å»ºä¿¡æ¯
            - ğŸ•’ æ„å»ºæ—¶é—´: ${{ steps.build-info.outputs.time }} (UTC+8)
            - ğŸ·ï¸ ç‰ˆæœ¬æ ‡ç­¾: ${{ github.ref_name }}
            - ğŸ”— æäº¤å“ˆå¸Œ: [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
            
            ### ğŸ” æ–‡ä»¶éªŒè¯
            ```bash
            # æ£€æŸ¥æ–‡ä»¶ç±»å‹
            file ok_school_life-*
            ```
          files: |
            release-files/ok_school_life-*